-- liquibase formatted sql

-- changeset kurumi:1743936727123-1
CREATE TABLE ban_history (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, user_id BIGINT NOT NULL, expires_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, banned_by BIGINT, reason VARCHAR(500), created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, dispute_approved BOOLEAN, dispute_reason VARCHAR(500), approved_by BIGINT, dispute_approved_at TIMESTAMP WITHOUT TIME ZONE, CONSTRAINT pk_ban_history PRIMARY KEY (id));

-- changeset kurumi:1743936727123-2
CREATE TABLE draft_actions (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, draft_id BIGINT NOT NULL, player_id BIGINT NOT NULL, character_name VARCHAR(255) NOT NULL, is_pick BOOLEAN NOT NULL, step_index INTEGER NOT NULL, created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, CONSTRAINT pk_draft_actions PRIMARY KEY (id));

-- changeset kurumi:1743936727123-3
CREATE TABLE draft_characters (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, name VARCHAR(255) NOT NULL, element VARCHAR(255) NOT NULL, level INTEGER NOT NULL, rarity INTEGER NOT NULL, constellations INTEGER NOT NULL, CONSTRAINT pk_draft_characters PRIMARY KEY (id));

-- changeset kurumi:1743936727123-4
CREATE TABLE draft_player1_characters (character_id BIGINT NOT NULL, draft_id BIGINT NOT NULL, CONSTRAINT pk_draft_player1_characters PRIMARY KEY (character_id, draft_id));

-- changeset kurumi:1743936727123-5
CREATE TABLE draft_player2_characters (character_id BIGINT NOT NULL, draft_id BIGINT NOT NULL, CONSTRAINT pk_draft_player2_characters PRIMARY KEY (character_id, draft_id));

-- changeset kurumi:1743936727123-6
CREATE TABLE game_items (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, name VARCHAR(255), collection VARCHAR(255), type INTEGER NOT NULL, rarity INTEGER NOT NULL, CONSTRAINT pk_game_items PRIMARY KEY (id));

-- changeset kurumi:1743936727123-7
CREATE TABLE match_drafts (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, current_state VARCHAR(255) NOT NULL, current_state_start_time TIMESTAMP WITHOUT TIME ZONE NOT NULL, current_step_index INTEGER NOT NULL, is_player1ready BOOLEAN NOT NULL, is_player2ready BOOLEAN NOT NULL, created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, match_id BIGINT NOT NULL, CONSTRAINT pk_match_drafts PRIMARY KEY (id));

-- changeset kurumi:1743936727123-8
CREATE TABLE match_invites (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, active_diff_seconds BIGINT NOT NULL, inviter_id BIGINT NOT NULL, invitee_id BIGINT NOT NULL, created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, CONSTRAINT pk_match_invites PRIMARY KEY (id));

-- changeset kurumi:1743936727123-9
CREATE TABLE matches (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, started_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, ended_at TIMESTAMP WITHOUT TIME ZONE, status VARCHAR(255) NOT NULL, technical_defeat_reason VARCHAR(255), winner_id BIGINT, player1_id BIGINT NOT NULL, player2_id BIGINT NOT NULL, CONSTRAINT pk_matches PRIMARY KEY (id));

-- changeset kurumi:1743936727123-10
CREATE TABLE room_results (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, room_number INTEGER NOT NULL, time INTEGER NOT NULL, completed_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, player_id BIGINT NOT NULL, match_id BIGINT NOT NULL, CONSTRAINT pk_room_results PRIMARY KEY (id));

-- changeset kurumi:1743936727123-11
CREATE TABLE room_retries (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, room_number INTEGER NOT NULL, time INTEGER NOT NULL, completed_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, player_id BIGINT NOT NULL, match_id BIGINT NOT NULL, CONSTRAINT pk_room_retries PRIMARY KEY (id));

-- changeset kurumi:1743936727123-12
CREATE TABLE trades (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, status VARCHAR(255) NOT NULL, created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, initiator_id BIGINT NOT NULL, receiver_id BIGINT NOT NULL, CONSTRAINT pk_trades PRIMARY KEY (id));

-- changeset kurumi:1743936727123-13
CREATE TABLE user_global_statistics (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, matches_won INTEGER NOT NULL, matches_lost INTEGER NOT NULL, matches_draws INTEGER NOT NULL, summary_time_clear INTEGER NOT NULL, xp INTEGER NOT NULL, skill INTEGER NOT NULL, created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, user_id BIGINT, CONSTRAINT pk_user_global_statistics PRIMARY KEY (id));

-- changeset kurumi:1743936727123-14
CREATE TABLE user_items (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, source_type VARCHAR(255) NOT NULL, trade_id BIGINT, created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, user_id BIGINT NOT NULL, item_id BIGINT NOT NULL, CONSTRAINT pk_user_items PRIMARY KEY (id));

-- changeset kurumi:1743936727123-15
CREATE TABLE users (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, username VARCHAR(255), password VARCHAR(255) NOT NULL, hwid VARCHAR(255), created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, access_level INTEGER NOT NULL, avatar_url VARCHAR(255), receive_match_invites BOOLEAN NOT NULL, banned_until TIMESTAMP WITHOUT TIME ZONE, ban_reason VARCHAR(255), current_match_id BIGINT, current_badge_id BIGINT, CONSTRAINT pk_users PRIMARY KEY (id));

-- changeset kurumi:1743936727123-16
ALTER TABLE users ADD CONSTRAINT UC_USERS_HWID UNIQUE (hwid);

-- changeset kurumi:1743936727123-17
ALTER TABLE users ADD CONSTRAINT UC_USERS_USERNAME UNIQUE (username);

-- changeset kurumi:1743936727123-19
ALTER TABLE ban_history ADD CONSTRAINT FK_BAN_HISTORY_ON_APPROVED_BY FOREIGN KEY (approved_by) REFERENCES users (id);

-- changeset kurumi:1743936727123-20
ALTER TABLE ban_history ADD CONSTRAINT FK_BAN_HISTORY_ON_BANNED_BY FOREIGN KEY (banned_by) REFERENCES users (id);

-- changeset kurumi:1743936727123-21
ALTER TABLE ban_history ADD CONSTRAINT FK_BAN_HISTORY_ON_USER FOREIGN KEY (user_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-22
ALTER TABLE draft_actions ADD CONSTRAINT FK_DRAFT_ACTIONS_ON_DRAFT FOREIGN KEY (draft_id) REFERENCES match_drafts (id);

-- changeset kurumi:1743936727123-23
ALTER TABLE draft_actions ADD CONSTRAINT FK_DRAFT_ACTIONS_ON_PLAYER FOREIGN KEY (player_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-24
ALTER TABLE draft_player2_characters ADD CONSTRAINT FK_DRAPLACHA_ON_DRAFT_CHARACTER FOREIGN KEY (character_id) REFERENCES draft_characters (id);

-- changeset kurumi:1743936727123-25
ALTER TABLE draft_player1_characters ADD CONSTRAINT "FK_DRAPLACHA_ON_DRAFT_CHARACTERqnFgsB" FOREIGN KEY (character_id) REFERENCES draft_characters (id);

-- changeset kurumi:1743936727123-26
ALTER TABLE draft_player2_characters ADD CONSTRAINT FK_DRAPLACHA_ON_MATCH_DRAFT FOREIGN KEY (draft_id) REFERENCES match_drafts (id);

-- changeset kurumi:1743936727123-27
ALTER TABLE draft_player1_characters ADD CONSTRAINT "FK_DRAPLACHA_ON_MATCH_DRAFTKNYHwP" FOREIGN KEY (draft_id) REFERENCES match_drafts (id);

-- changeset kurumi:1743936727123-28
ALTER TABLE matches ADD CONSTRAINT FK_MATCHES_ON_PLAYER1 FOREIGN KEY (player1_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-29
ALTER TABLE matches ADD CONSTRAINT FK_MATCHES_ON_PLAYER2 FOREIGN KEY (player2_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-30
ALTER TABLE matches ADD CONSTRAINT FK_MATCHES_ON_WINNER FOREIGN KEY (winner_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-31
ALTER TABLE match_drafts ADD CONSTRAINT FK_MATCH_DRAFTS_ON_MATCH FOREIGN KEY (match_id) REFERENCES matches (id);

-- changeset kurumi:1743936727123-32
ALTER TABLE match_invites ADD CONSTRAINT FK_MATCH_INVITES_ON_INVITEE FOREIGN KEY (invitee_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-33
ALTER TABLE match_invites ADD CONSTRAINT FK_MATCH_INVITES_ON_INVITER FOREIGN KEY (inviter_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-34
ALTER TABLE room_results ADD CONSTRAINT FK_ROOM_RESULTS_ON_MATCH FOREIGN KEY (match_id) REFERENCES matches (id);

-- changeset kurumi:1743936727123-35
ALTER TABLE room_results ADD CONSTRAINT FK_ROOM_RESULTS_ON_PLAYER FOREIGN KEY (player_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-36
ALTER TABLE room_retries ADD CONSTRAINT FK_ROOM_RETRIES_ON_MATCH FOREIGN KEY (match_id) REFERENCES matches (id);

-- changeset kurumi:1743936727123-37
ALTER TABLE room_retries ADD CONSTRAINT FK_ROOM_RETRIES_ON_PLAYER FOREIGN KEY (player_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-38
ALTER TABLE trades ADD CONSTRAINT FK_TRADES_ON_INITIATOR FOREIGN KEY (initiator_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-39
ALTER TABLE trades ADD CONSTRAINT FK_TRADES_ON_RECEIVER FOREIGN KEY (receiver_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-40
ALTER TABLE users ADD CONSTRAINT FK_USERS_ON_CURRENT_BADGE FOREIGN KEY (current_badge_id) REFERENCES user_items (id);

-- changeset kurumi:1743936727123-41
ALTER TABLE users ADD CONSTRAINT FK_USERS_ON_CURRENT_MATCH FOREIGN KEY (current_match_id) REFERENCES matches (id);

-- changeset kurumi:1743936727123-42
ALTER TABLE user_global_statistics ADD CONSTRAINT FK_USER_GLOBAL_STATISTICS_ON_USER FOREIGN KEY (user_id) REFERENCES users (id);

-- changeset kurumi:1743936727123-43
ALTER TABLE user_items ADD CONSTRAINT FK_USER_ITEMS_ON_ITEM FOREIGN KEY (item_id) REFERENCES game_items (id);

-- changeset kurumi:1743936727123-44
ALTER TABLE user_items ADD CONSTRAINT FK_USER_ITEMS_ON_TRADE FOREIGN KEY (trade_id) REFERENCES trades (id);

-- changeset kurumi:1743936727123-45
ALTER TABLE user_items ADD CONSTRAINT FK_USER_ITEMS_ON_USER FOREIGN KEY (user_id) REFERENCES users (id);

ALTER TABLE room_results ADD CONSTRAINT uk_room_player_match_no_retry
UNIQUE (match_id, player_id, room_number);
